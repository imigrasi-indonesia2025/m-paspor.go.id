<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Setup Database - M-Paspor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .glass-effect {
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .log-item {
            animation: slideIn 0.3s ease-out;
        }
        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }
    </style>
</head>
<body class="gradient-bg min-h-screen">
    <!-- Header -->
    <header class="glass-effect p-4 shadow-lg">
        <div class="max-w-4xl mx-auto flex items-center justify-between">
            <div class="flex items-center space-x-3">
                <i class="fas fa-database text-2xl text-white"></i>
                <div>
                    <h1 class="text-xl font-bold text-white">Setup Database M-Paspor</h1>
                    <p class="text-sm text-indigo-100">Konfigurasi Database & Admin</p>
                </div>
            </div>
            <a href="index.html" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition-colors duration-300">
                <i class="fas fa-arrow-left mr-2"></i>Kembali
            </a>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-4xl mx-auto p-4 mt-6">
        <!-- Setup Status -->
        <div class="glass-effect rounded-2xl p-6 mb-6 fade-in">
            <h2 class="text-xl font-bold text-white mb-4">Status Setup Database</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="bg-white bg-opacity-10 rounded-lg p-4 text-center">
                    <i class="fas fa-database text-2xl text-blue-300 mb-2"></i>
                    <p class="text-white font-medium">Koneksi Database</p>
                    <p class="text-sm text-indigo-200" id="dbStatus">Checking...</p>
                </div>
                <div class="bg-white bg-opacity-10 rounded-lg p-4 text-center">
                    <i class="fas fa-user-shield text-2xl text-green-300 mb-2"></i>
                    <p class="text-white font-medium">Admin Account</p>
                    <p class="text-sm text-indigo-200" id="adminStatus">Checking...</p>
                </div>
                <div class="bg-white bg-opacity-10 rounded-lg p-4 text-center">
                    <i class="fas fa-cog text-2xl text-yellow-300 mb-2"></i>
                    <p class="text-white font-medium">Collections</p>
                    <p class="text-sm text-indigo-200" id="collectionsStatus">Checking...</p>
                </div>
            </div>
        </div>

        <!-- Setup Actions -->
        <div class="glass-effect rounded-2xl p-6 mb-6 fade-in">
            <h3 class="text-xl font-bold text-white mb-4">Setup Actions</h3>
            <div class="space-y-4">
                <button id="createAdminBtn" class="w-full bg-green-500 hover:bg-green-600 text-white p-4 rounded-lg transition-colors duration-300 flex items-center justify-center space-x-2">
                    <i class="fas fa-user-plus"></i>
                    <span>Buat Akun Admin (admin@paspor.com)</span>
                </button>
                
                <button id="setupCollectionsBtn" class="w-full bg-blue-500 hover:bg-blue-600 text-white p-4 rounded-lg transition-colors duration-300 flex items-center justify-center space-x-2">
                    <i class="fas fa-database"></i>
                    <span>Setup Collections Database</span>
                </button>
                
                <button id="createSampleDataBtn" class="w-full bg-purple-500 hover:bg-purple-600 text-white p-4 rounded-lg transition-colors duration-300 flex items-center justify-center space-x-2">
                    <i class="fas fa-file-import"></i>
                    <span>Buat Sample Data Permohonan</span>
                </button>
                
                <button id="testSystemBtn" class="w-full bg-orange-500 hover:bg-orange-600 text-white p-4 rounded-lg transition-colors duration-300 flex items-center justify-center space-x-2">
                    <i class="fas fa-vial"></i>
                    <span>Test Sistem Lengkap</span>
                </button>
            </div>
        </div>

        <!-- Admin Credentials -->
        <div class="glass-effect rounded-2xl p-6 mb-6 fade-in">
            <h3 class="text-xl font-bold text-white mb-4">Kredensial Admin</h3>
            <div class="bg-white bg-opacity-10 rounded-lg p-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-white font-medium mb-2">Email Admin:</label>
                        <div class="bg-gray-800 text-green-300 p-3 rounded font-mono text-sm">
                            admin@paspor.com
                        </div>
                    </div>
                    <div>
                        <label class="block text-white font-medium mb-2">Password Admin:</label>
                        <div class="bg-gray-800 text-green-300 p-3 rounded font-mono text-sm">
                            admin123456
                        </div>
                    </div>
                </div>
                <p class="text-indigo-200 text-sm mt-3">
                    <i class="fas fa-info-circle mr-1"></i>
                    Gunakan kredensial ini untuk login sebagai admin setelah setup selesai.
                </p>
            </div>
        </div>

        <!-- Setup Log -->
        <div class="glass-effect rounded-2xl p-6 fade-in">
            <h3 class="text-xl font-bold text-white mb-4">Setup Log</h3>
            <div class="bg-black bg-opacity-30 rounded-lg p-4 h-64 overflow-y-auto" id="setupLog">
                <p class="text-green-300 text-sm font-mono">Sistem siap untuk setup...</p>
            </div>
        </div>
    </main>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBKu6dfVVLFLkq7w7PCj20gkarMJG-aCg0",
            authDomain: "arisan-online-b90a2.firebaseapp.com",
            projectId: "arisan-online-b90a2",
            storageBucket: "arisan-online-b90a2.firebasestorage.app",
            messagingSenderId: "77633850940",
            appId: "1:77633850940:web:df0454a209121dc51d7d39",
            measurementId: "G-0REH8Q0W2D"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // Log function
        function addLog(message, type = 'info') {
            const logContainer = document.getElementById('setupLog');
            const logItem = document.createElement('div');
            logItem.className = 'log-item text-sm font-mono mb-1';
            
            const timestamp = new Date().toLocaleTimeString();
            const colors = {
                info: 'text-blue-300',
                success: 'text-green-300',
                error: 'text-red-300',
                warning: 'text-yellow-300'
            };
            
            logItem.className += ` ${colors[type]}`;
            logItem.textContent = `[${timestamp}] ${message}`;
            
            logContainer.appendChild(logItem);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        // Check database status
        async function checkDatabaseStatus() {
            try {
                addLog('Memeriksa koneksi database...', 'info');
                
                // Test Firestore connection
                await db.collection('test').doc('connection').set({
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    status: 'connected'
                });
                
                document.getElementById('dbStatus').textContent = 'Connected';
                document.getElementById('dbStatus').className = 'text-sm text-green-300';
                addLog('✓ Koneksi database berhasil', 'success');
                
                // Clean up test document
                await db.collection('test').doc('connection').delete();
                
            } catch (error) {
                document.getElementById('dbStatus').textContent = 'Error';
                document.getElementById('dbStatus').className = 'text-sm text-red-300';
                addLog('✗ Gagal terhubung ke database: ' + error.message, 'error');
            }
        }

        // Check admin status
        async function checkAdminStatus() {
            try {
                addLog('Memeriksa akun admin...', 'info');
                
                const adminQuery = await db.collection('users').where('email', '==', 'admin@paspor.com').get();
                
                if (!adminQuery.empty) {
                    document.getElementById('adminStatus').textContent = 'Exists';
                    document.getElementById('adminStatus').className = 'text-sm text-green-300';
                    addLog('✓ Akun admin sudah ada', 'success');
                } else {
                    document.getElementById('adminStatus').textContent = 'Not Found';
                    document.getElementById('adminStatus').className = 'text-sm text-yellow-300';
                    addLog('! Akun admin belum dibuat', 'warning');
                }
                
            } catch (error) {
                document.getElementById('adminStatus').textContent = 'Error';
                document.getElementById('adminStatus').className = 'text-sm text-red-300';
                addLog('✗ Gagal memeriksa admin: ' + error.message, 'error');
            }
        }

        // Check collections status
        async function checkCollectionsStatus() {
            try {
                addLog('Memeriksa collections database...', 'info');
                
                const collections = ['users', 'applications'];
                let allExist = true;
                
                for (const collection of collections) {
                    const snapshot = await db.collection(collection).limit(1).get();
                    if (snapshot.empty) {
                        addLog(`! Collection '${collection}' kosong`, 'warning');
                    } else {
                        addLog(`✓ Collection '${collection}' ada`, 'success');
                    }
                }
                
                document.getElementById('collectionsStatus').textContent = 'Ready';
                document.getElementById('collectionsStatus').className = 'text-sm text-green-300';
                
            } catch (error) {
                document.getElementById('collectionsStatus').textContent = 'Error';
                document.getElementById('collectionsStatus').className = 'text-sm text-red-300';
                addLog('✗ Gagal memeriksa collections: ' + error.message, 'error');
            }
        }

        // Create admin account
        async function createAdminAccount() {
            try {
                addLog('Membuat akun admin...', 'info');
                
                // Create admin user with Firebase Auth
                const userCredential = await auth.createUserWithEmailAndPassword('admin@paspor.com', 'admin123456');
                const user = userCredential.user;
                
                // Add admin data to Firestore
                await db.collection('users').doc(user.uid).set({
                    name: 'Administrator',
                    email: 'admin@paspor.com',
                    role: 'admin',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    isActive: true
                });
                
                addLog('✓ Akun admin berhasil dibuat', 'success');
                addLog('Email: admin@paspor.com', 'info');
                addLog('Password: admin123456', 'info');
                
                // Sign out after creating admin
                await auth.signOut();
                
                // Update status
                document.getElementById('adminStatus').textContent = 'Created';
                document.getElementById('adminStatus').className = 'text-sm text-green-300';
                
            } catch (error) {
                if (error.code === 'auth/email-already-in-use') {
                    addLog('! Akun admin sudah ada', 'warning');
                    
                    // Try to update user role in Firestore
                    try {
                        const adminQuery = await db.collection('users').where('email', '==', 'admin@paspor.com').get();
                        if (!adminQuery.empty) {
                            const adminDoc = adminQuery.docs[0];
                            await adminDoc.ref.update({
                                role: 'admin',
                                name: 'Administrator',
                                isActive: true
                            });
                            addLog('✓ Role admin diperbarui', 'success');
                        }
                    } catch (updateError) {
                        addLog('✗ Gagal memperbarui role admin: ' + updateError.message, 'error');
                    }
                } else {
                    addLog('✗ Gagal membuat admin: ' + error.message, 'error');
                }
            }
        }

        // Setup collections
        async function setupCollections() {
            try {
                addLog('Mengatur collections database...', 'info');
                
                // Create indexes and initial documents
                const collections = [
                    {
                        name: 'users',
                        sampleDoc: {
                            name: 'Sample User',
                            email: 'user@example.com',
                            role: 'user',
                            createdAt: firebase.firestore.FieldValue.serverTimestamp()
                        }
                    },
                    {
                        name: 'applications',
                        sampleDoc: {
                            name: 'Sample Application',
                            email: 'user@example.com',
                            status: 'pending',
                            createdAt: firebase.firestore.FieldValue.serverTimestamp()
                        }
                    }
                ];
                
                for (const collection of collections) {
                    await db.collection(collection.name).doc('sample').set(collection.sampleDoc);
                    addLog(`✓ Collection '${collection.name}' siap`, 'success');
                    
                    // Delete sample document
                    await db.collection(collection.name).doc('sample').delete();
                }
                
                addLog('✓ Semua collections berhasil diatur', 'success');
                
            } catch (error) {
                addLog('✗ Gagal setup collections: ' + error.message, 'error');
            }
        }

        // Create sample data
        async function createSampleData() {
            try {
                addLog('Membuat sample data permohonan...', 'info');
                
                const sampleApplications = [
                    {
                        name: 'John Doe',
                        email: 'john@example.com',
                        phone: '081234567890',
                        nik: '1234567890123456',
                        birthPlace: 'Jakarta',
                        birthDate: '1990-01-01',
                        address: 'Jl. Contoh No. 123, Jakarta',
                        status: 'pending',
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    },
                    {
                        name: 'Jane Smith',
                        email: 'jane@example.com',
                        phone: '081234567891',
                        nik: '1234567890123457',
                        birthPlace: 'Bandung',
                        birthDate: '1992-05-15',
                        address: 'Jl. Sample No. 456, Bandung',
                        status: 'approved',
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        approvedAt: firebase.firestore.FieldValue.serverTimestamp()
                    },
                    {
                        name: 'Bob Wilson',
                        email: 'bob@example.com',
                        phone: '081234567892',
                        nik: '1234567890123458',
                        birthPlace: 'Surabaya',
                        birthDate: '1988-12-20',
                        address: 'Jl. Demo No. 789, Surabaya',
                        status: 'payment',
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        approvedAt: firebase.firestore.FieldValue.serverTimestamp(),
                        paymentInfo: {
                            recipientName: 'M-Paspor Indonesia',
                            accountNumber: '1234567890',
                            bankName: 'BCA',
                            amount: 355000,
                            deadline: new Date(Date.now() + 24 * 60 * 60 * 1000),
                            createdAt: firebase.firestore.FieldValue.serverTimestamp()
                        }
                    }
                ];
                
                for (let i = 0; i < sampleApplications.length; i++) {
                    await db.collection('applications').add(sampleApplications[i]);
                    addLog(`✓ Sample application ${i + 1} dibuat`, 'success');
                }
                
                addLog('✓ Semua sample data berhasil dibuat', 'success');
                
            } catch (error) {
                addLog('✗ Gagal membuat sample data: ' + error.message, 'error');
            }
        }

        // Test system
        async function testSystem() {
            try {
                addLog('Memulai test sistem...', 'info');
                
                // Test 1: Database connection
                addLog('Test 1: Koneksi database...', 'info');
                await db.collection('test').doc('system-test').set({
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
                await db.collection('test').doc('system-test').delete();
                addLog('✓ Test koneksi database berhasil', 'success');
                
                // Test 2: Admin account
                addLog('Test 2: Akun admin...', 'info');
                const adminQuery = await db.collection('users').where('email', '==', 'admin@paspor.com').get();
                if (!adminQuery.empty) {
                    addLog('✓ Akun admin ditemukan', 'success');
                } else {
                    addLog('✗ Akun admin tidak ditemukan', 'error');
                }
                
                // Test 3: Collections
                addLog('Test 3: Collections...', 'info');
                const collections = ['users', 'applications'];
                for (const collection of collections) {
                    const snapshot = await db.collection(collection).limit(1).get();
                    addLog(`✓ Collection '${collection}' dapat diakses`, 'success');
                }
                
                // Test 4: CRUD operations
                addLog('Test 4: CRUD operations...', 'info');
                const testDoc = await db.collection('applications').add({
                    name: 'Test User',
                    email: 'test@example.com',
                    status: 'pending',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                await testDoc.update({ status: 'approved' });
                await testDoc.delete();
                addLog('✓ CRUD operations berhasil', 'success');
                
                addLog('🎉 Semua test berhasil! Sistem siap digunakan.', 'success');
                
            } catch (error) {
                addLog('✗ Test sistem gagal: ' + error.message, 'error');
            }
        }

        // Event listeners
        document.getElementById('createAdminBtn').addEventListener('click', createAdminAccount);
        document.getElementById('setupCollectionsBtn').addEventListener('click', setupCollections);
        document.getElementById('createSampleDataBtn').addEventListener('click', createSampleData);
        document.getElementById('testSystemBtn').addEventListener('click', testSystem);

        // Initialize checks
        window.addEventListener('load', () => {
            setTimeout(() => {
                checkDatabaseStatus();
                checkAdminStatus();
                checkCollectionsStatus();
            }, 1000);
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9779b003f6233dfb',t:'MTc1NjYxMzUyNS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
